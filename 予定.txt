今の症状は「チャンク説明の要約」で止まっており、「質問への直接回答」になっていない典型例です。複数チャンクで同じ意味ならまとめてユーザーへ返答
現状はベストプラクティス未満。検索・選定・生成・UXを一式で見直すと改善するので改修します。
UXに関してはデザイン原則で最後に改修。

### 改善ポイント（検索・選定）
- 最初のリトリーブ強化
  - **top_kを広げる**（例: 30〜50）→ その後に絞り込む。
  - 既存のRRFは活かしつつ、最終段に**クロスエンコーダ再ランキング**を追加（例: `bge-reranker-large` か OpenAI ReRanker）。質問との関連度で上位10〜15件を確定。
- 多様性確保と重複抑制
  - **MMR**（最大余剰関連）または**クラスタリング（埋め込みの凝集; cos>0.85）**で似たチャンクを束ね、クラスタごとに代表1〜2件に限定。
  - **近接重複除去**（cos>0.95や`chunk_hash`一致）で同義重複を折りたたみ、引用は「代表＋同義参照IDsの集合」で提示。
- スコア設計
  - ベクトル×BM25×メタ（新しさ・重要度）をRRFで統合済みなら、そこに**新規性ペナルティ（同クラスタ反復の減点）**を加えると「似たカード連発」を防げます。

### 回答生成（要約ではなく回答へ）
- 生成プロンプトの役割変更
  - 「チャンク説明の要約」ではなく**“質問に答える”**ことを主目的に。加えて「根拠チャンクIDを明示」「不足時は不足と宣言」という制約を入れる。
- Map-Reduce合成
  - Map: 各チャンクから「質問に対する候補回答＋根拠スパン」を抽出。
  - Reduce: 候補を統合し、矛盾を解消。**文単位で引用IDをマージ**（同じ主張に複数の根拠を付与）。
- 反証・不足検出
  - 相互矛盾検出（簡易規則 or LLM）で「意見分岐がある」ことを明記。
  - 情報不足時は**追加入力を明示依頼**（例: 期間/バージョン/部門など）。

プロンプト雛形（要点のみ）

```text
あなたは企業内ナレッジの回答支援AIです。必ずユーザーの質問に直接答え、
与えられたコンテキスト以外は使わないでください。情報が不足していれば不足を明言し、
不足情報を列挙してください。回答内の各主張に対応する根拠chunk_idを角括弧で示し、
同義根拠が複数あれば併記してください（例: [C12, C34]）。

出力:
回答:
- 箇条書きの短文で、質問に直接答える。各文末に [chunk_id,…]

不足/前提:
- 不足があれば列挙（なければ「なし」）

根拠:
- Cxx: 短い抜粋（最大120字）
```

### UX提案（重複をまとめ、根拠を見やすく）
- 画面構成
  - 上段に**「回答（短く）」**。その下に**「根拠（折りたたみ）」**を表示。
  - 根拠は**トピックごとにグルーピング**（クラスタ単位）。各主張の右に**[C12, C34]**のように複数引用を併記。
- 重複抑制のUI
  - 検索結果リストに「**類似をまとめる**」トグルを追加。オン時は同義チャンクを1カードに統合し、「他の同義x件を表示」を展開可能に。
- 根拠の精度表示
  - 各根拠に「一致度」「更新日」「該当箇所抜粋」を小さく表示。内部ビューをワンクリックで開ける導線を維持。
- 追問支援
  - 回答下に**不足情報のチップ**（期間、対象製品、部門など）を表示してクリック追問。

### 実装手順（最短ルート）
1. リトリーバ後処理に**MMRまたはクラスタリング**＋**近接重複除去**を追加（cos閾値 0.95/0.85 目安）。
2. 最終段に**クロスエンコーダ再ランキング**を差し込み（上位10〜15件）。
3. 生成側を**“回答ファースト＋文別引用併記”**のテンプレートに変更。Map-Reduce合成で文単位の引用マージ。
4. UIに「**回答**」「**根拠（グループ化）**」「**類似をまとめる**トグル」追加。
5. メトリクス導入：Helpful（質問充足度）/Grounded（根拠整合）/冗長率（同義重複率）を`ERROR_LOG.md`とは別に集計。

この方針なら、「チャンク説明」ではなく「質問への直接回答＋複数根拠併記」を実装。`rag_engine`の候補整形（MMR/クラスタ）、生成プロンプト、StreamlitのUIトグル追加まで具体的編集